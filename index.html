<html>
	<head>
	</head>
	<body>

		<canvas id="game_field" width="900" height="900" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
		<canvas id="map" width="900" height="900" style="position: absolute; left: 0; top: 0; z-index: -2;"></canvas>
		<canvas id="meta" width="900" height="900" style="position: absolute; left: 0; top: 0; z-index: -1;"></canvas>

		<script type="text/javascript" src="engine/drawer.js"></script>
		<script type="text/javascript" src="engine/map.js"></script>
		<script type="text/javascript" src="engine/game_object.js"></script>
		<script type="text/javascript" src="bullet.js"></script>
		<script type="text/javascript" src="engine/math_helper.js"></script>

		<script type="text/javascript">

			const CANVAS_WIDTH = 900
			const CANVAS_HEIGHT = 900;

			const SPRITE_WIDTH = 36;
			const SPRITE_HEIGHT = 36;

			const BLOCK_SIZE = 36;

			let map_src = [
				"xxxxxxxxxxxxxxxxxxxxxxxxx",
				"..............xxxxxxxxxxx",
				"xxxxxxxxxxxxx.xxxxxxxxxxx",
				"xxxxxxxxxxxxx.xxxxxxxxxxx",
				"xxxxxxxxxxxxx............",
			];

			let map_ctx = document.getElementById("map").getContext("2d");
			let game_field_ctx = document.getElementById("game_field").getContext("2d");


			let map_drawer = new Drawer(map_ctx, CANVAS_WIDTH, CANVAS_HEIGHT);
			let objects_drawer = new Drawer(game_field_ctx, CANVAS_WIDTH, CANVAS_HEIGHT);

			let map = new Map(5, 25, map_src, map_drawer);
			map.render();

			let enemy = new GameObject(0, BLOCK_SIZE, objects_drawer);
			enemy.set_sprite("sprites/towerDefense_tile270.png");


			let tower1 = new GameObject(7 * BLOCK_SIZE, 2 * BLOCK_SIZE, objects_drawer);
			tower1.set_sprite("sprites/towerDefense_tile250.png");

			let tower2 = new GameObject(14 * BLOCK_SIZE, 3 * BLOCK_SIZE, objects_drawer);
			tower2.set_sprite("sprites/towerDefense_tile250.png");

			let enemies = [enemy];
			let towers = [tower1, tower2];
			let bullets = [];

			let path = [[13, 1, 2, 0], [13, 4, 0, 2], [25, 4, 2, 0], [-1, -1, -1, -1]];
			let path_len = 3;

			let k = 0;

			let t = 0;
			let max_t = 10;

			setInterval(function(){

				objects_drawer.clear();

				for(let enemy of enemies){

					if(k != path_len){
						enemy.x += path[k][2];
						enemy.y += path[k][3];
						enemy.render();
					}else{
						enemies.pop();
					}

					if(Math.floor(enemy.x / BLOCK_SIZE) == path[k][0] && Math.floor(enemy.y / BLOCK_SIZE) == path[k][1]){
						k++;
					}
				}

				let r = 72;

				for(let tower of towers){

					if(is_in_radius(tower, enemy, r)){
						
						if(t == max_t){

							let bullet = new Bullet(tower, enemy, objects_drawer);
							bullet.set_sprite("sprites/towerDefense_tile295.png");

							bullets.push(bullet);
							
							t = 0;
						}

						t++;

					}

					tower.render();
				
				}

				for(let b of bullets){
					b.render();
					b.update();
				}

			}, 20);

		</script>

	</body>
</html>